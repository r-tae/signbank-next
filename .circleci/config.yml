# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
  node: circleci/node@5.0.2
  cypress: cypress-io/cypress@1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build:
    executor: node/default
    working_directory: ~/project
    steps:
      - checkout
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - yarn-packages-{{ checksum "yarn.lock" }}
      - run:
          name: Install Dependencies
          command: yarn install --production=false --frozen-lockfile
      - save_cache:
          name: Save Yarn Package Cache
          key: yarn-packages-{{ checksum "yarn.lock" }}
          paths:
            - .yarn/cache
            - .yarn/unplugged
      - persist_to_workspace:
          root: ~/
          paths:
            - project
            - .cache

  test:
    docker:
      - image: cypress/base:14.16.0
        environment:
          ## this enables colors in the output
          TERM: xterm
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Run tests
          command: yarn cypress:ci
      - store_test_results:
          path: results

  unit_tests:
    executor: node/default
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Run unit tests
          command: yarn test

  # TODO: finish setting up browserstack cypress tests
  # NOTE: until then, we will just have local cypress tests
  integration_tests:
    executor: node/default
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Download browserstack local binary
          command: wget "https://www.browserstack.com/browserstack-local/BrowserStackLocal-linux-x64.zip"
      - run:
          name: Unzip browserstack local binary
          command: unzip BrowserStackLocal-linux-x64.zip
      - run:
          name: Run browserstack local binary
          command: ./BrowserStackLocal $BROWSERSTACK_ACCESS_KEY
          background: true
      - run:
          name: Run integration tests
          command: yarn cypress:ci

workflows:
  integration_tests:
    jobs:
      - build
      # Run unit and integration tests in parallel
      - test:
          requires:
            - build
